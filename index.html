<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="description" content="2026å¹´2æœˆç´è¥¿è˜­å—å³¶è‡ªé§•æ—…éŠè¡Œç¨‹è¦åŠƒ">
  <meta name="theme-color" content="#2a7c6f">

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="NZ Trip 2026">

  <title>ç´è¥¿è˜­å—å³¶ 2026</title>
  <style>
    :root {
      --primary: #2a7c6f;
      --primary-dark: #1e5d54;
      --primary-light: #e6f2ef;
      --accent: #c8956c;
      --accent-light: #fdf0e5;
      --bg: #f5f4f1;
      --surface: #ffffff;
      --text: #1c2b28;
      --text-2: #5f7672;
      --text-3: #94a5a1;
      --border: #e4e8e7;
      --shadow: 0 1px 3px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
      --r: 10px;
      --r-sm: 7px;
      --font: "PingFang TC","Noto Sans TC","Microsoft JhengHei",-apple-system,sans-serif;
      --type-æ™¯é»: #2a7c6f; --type-æ™¯é»-bg: #e6f2ef;
      --type-åƒå–: #c8956c; --type-åƒå–-bg: #fdf0e5;
      --type-ç§»å‹•: #6889a0; --type-ç§»å‹•-bg: #e8f0f5;
      --type-ä½œæ¥­: #8b7da8; --type-ä½œæ¥­-bg: #eeeaf5;
      --type-ä½å®¿: #a08060; --type-ä½å®¿-bg: #f5efe8;
      --type-åƒè€ƒ: #d97706; --type-åƒè€ƒ-bg: #fef3c7;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html{scroll-behavior:smooth;-webkit-tap-highlight-color:transparent}
    body{font-family:var(--font);background:var(--bg);color:var(--text);line-height:1.6;-webkit-font-smoothing:antialiased;overflow-x:hidden}
    a{color:var(--primary);text-decoration:none}

    /* ===== Header ===== */
    .header{background:linear-gradient(135deg,#1a4f47,#2a7c6f 40%,#3a9888);color:#fff;padding:2.5rem 1.5rem 2rem;text-align:center;position:relative}
    .header::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:14px;background:var(--bg);border-radius:14px 14px 0 0}
    .header h1{font-size:1.4rem;font-weight:700;letter-spacing:.04em;margin-bottom:.2rem}
    .header .sub{font-size:.8rem;opacity:.8;margin-bottom:.5rem}
    .header .badges{display:flex;justify-content:center;gap:.5rem;flex-wrap:wrap}
    .header .hbadge{display:inline-flex;align-items:center;gap:.25rem;background:rgba(255,255,255,.18);padding:.2rem .7rem;border-radius:20px;font-size:.72rem;backdrop-filter:blur(4px)}

    /* ===== Tabs ===== */
    .tabs{display:flex;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:999;box-shadow:0 2px 4px rgba(0,0,0,0.05)}
    .tab{flex:1;text-align:center;padding:.5rem 0 .45rem;font-size:.75rem;font-weight:500;color:var(--text-2);cursor:pointer;border-bottom:2.5px solid transparent;transition:all .2s;user-select:none}
    .tab.on{color:var(--primary);border-bottom-color:var(--primary);font-weight:600}
    .tab .ti{font-size:.9rem;display:block;margin-bottom:.08rem}

    /* ===== Day Selector ===== */
    .day-sel{display:flex;gap:.4rem;padding:.6rem .8rem;overflow-x:auto;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:62px;z-index:998;-webkit-overflow-scrolling:touch;scrollbar-width:none}
    .day-sel::-webkit-scrollbar{display:none}
    .dp{flex-shrink:0;padding:.3rem .65rem;border-radius:18px;font-size:.72rem;cursor:pointer;background:var(--bg);color:var(--text-2);border:1px solid var(--border);transition:all .2s;text-align:center;min-width:44px;user-select:none;line-height:1.4}
    .dp.on{background:var(--primary);color:#fff;border-color:var(--primary);font-weight:600}
    .dp .dd{font-weight:500;font-size:.73rem}
    .dp .dw{font-size:.62rem;opacity:.7}
    .dp .dn{font-size:.62rem;opacity:.5;margin-top:1px}

    /* ===== Content ===== */
    .ct{padding:1rem;max-width:640px;margin:0 auto;padding-bottom:3rem;min-height:100vh}

    /* ===== Day Header ===== */
    .dh h2{font-size:1.2rem;font-weight:700;margin-bottom:.15rem;line-height:1.3}
    .dh .ddate{font-size:.8rem;color:var(--text-2);margin-bottom:.75rem}

    /* ===== Stats ===== */
    .stats{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.75rem}
    .st{display:inline-flex;align-items:center;gap:.25rem;padding:.25rem .55rem;background:var(--primary-light);color:var(--primary-dark);border-radius:5px;font-size:.72rem;font-weight:500}

    /* ===== Drive Note ===== */
    .dnote{background:#fef9ef;border-left:3px solid var(--accent);padding:.45rem .7rem;margin-bottom:.85rem;font-size:.78rem;border-radius:0 6px 6px 0;color:#7a6540}

    /* ===== Weather Info ===== */
    .weather-info{background:#e0f7fa;border-left:3px solid #00bcd4;padding:.45rem .7rem;margin-bottom:.85rem;font-size:.78rem;border-radius:0 6px 6px 0;color:#006064}
    .weather-info a{color:#006064;text-decoration:underline}
    .weather-info .wi-label{font-weight:600;margin-right:.4em}
    .weather-info div{margin-bottom:.2em}
    .weather-info div:last-child{margin-bottom:0}

    /* ===== Map Section ===== */
    .map-sec{margin-bottom:.85rem;border-radius:var(--r-sm);overflow:hidden;background:var(--surface);box-shadow:var(--shadow)}
    .map-tog{display:flex;align-items:center;gap:.4rem;padding:.6rem .75rem;font-size:.82rem;color:var(--primary);cursor:pointer;font-weight:500;user-select:none}
    .map-tog svg{transition:transform .3s;flex-shrink:0}
    .map-sec.open .map-tog svg{transform:rotate(180deg)}
    .map-fr{height:0;overflow:hidden;transition:height .35s ease}
    .map-sec.open .map-fr{height:280px}
    .map-fr iframe{width:100%;height:280px;border:0;border-top:1px solid var(--border)}
    .map-open-btn{display:inline-flex;align-items:center;gap:.25rem;margin-left:auto;padding:.15rem .5rem;background:var(--primary-light);border-radius:4px;font-size:.7rem;color:var(--primary);text-decoration:none;flex-shrink:0}

    /* ===== Timeline ===== */
    .tl{position:relative;padding-left:1.6rem;margin-bottom:1rem}
    .tl::before{content:'';position:absolute;left:5px;top:8px;bottom:8px;width:2px;background:var(--border);border-radius:1px}

    /* ===== Activity Card ===== */
    .ac{position:relative;background:var(--surface);border-radius:var(--r-sm);box-shadow:var(--shadow);margin-bottom:.6rem;overflow:hidden}
    .ac::before{content:'';position:absolute;left:-1.6rem;top:.85rem;width:10px;height:10px;border-radius:50%;border:2px solid var(--surface);z-index:1;transform:translateX(-1px)}
    .ac[data-t="æ™¯é»"]::before{background:var(--type-æ™¯é»)}
    .ac[data-t="åƒå–"]::before{background:var(--type-åƒå–)}
    .ac[data-t="ç§»å‹•"]::before{background:var(--type-ç§»å‹•)}
    .ac[data-t="ä½œæ¥­"]::before{background:var(--type-ä½œæ¥­)}
    .ac[data-t="ä½å®¿"]::before{background:var(--type-ä½å®¿)}
    .ac[data-t="åƒè€ƒ"]::before{background:var(--type-åƒè€ƒ)}

    /* ===== Cancelled Activities ===== */
    .ac.cancelled{opacity:0.6;background:#f5f5f5}
    .ac.cancelled::before{opacity:0.5}
    .ac.cancelled .an{text-decoration:line-through;text-decoration-color:var(--text-3)}
    .ac.cancelled .ab{opacity:0.7}

    .ah{display:flex;flex-wrap:wrap;align-items:center;padding:.55rem .7rem .45rem;cursor:pointer;gap:.3rem .45rem;-webkit-tap-highlight-color:transparent}
    .ah-top{display:flex;align-items:center;gap:.45rem;width:100%;min-width:0}
    .an{flex:1;font-size:.88rem;font-weight:500;line-height:1.35;min-width:0;overflow:hidden;text-overflow:ellipsis}
    .ah-sub{display:flex;align-items:center;gap:.6rem;width:100%;padding-left:calc(.35rem + .7rem + .45rem);font-size:.72rem;color:var(--text-3);line-height:1.3}
    .ah-sub span{display:inline-flex;align-items:center;gap:.2rem;white-space:nowrap}
    .ah-drive{display:flex;align-items:center;gap:.3rem;padding:.2rem .7rem 0;font-size:.68rem;color:var(--type-ç§»å‹•);opacity:.8}
    .ab{flex-shrink:0;padding:.12rem .35rem;border-radius:3px;font-size:.6rem;font-weight:700;letter-spacing:.02em;text-transform:uppercase}
    .ab-æ™¯é»{background:var(--type-æ™¯é»-bg);color:var(--type-æ™¯é»)}
    .ab-åƒå–{background:var(--type-åƒå–-bg);color:var(--type-åƒå–)}
    .ab-ç§»å‹•{background:var(--type-ç§»å‹•-bg);color:var(--type-ç§»å‹•)}
    .ab-ä½œæ¥­{background:var(--type-ä½œæ¥­-bg);color:var(--type-ä½œæ¥­)}
    .ab-ä½å®¿{background:var(--type-ä½å®¿-bg);color:var(--type-ä½å®¿)}
    .ab-åƒè€ƒ{background:var(--type-åƒè€ƒ-bg);color:var(--type-åƒè€ƒ)}
    .chev{flex-shrink:0;width:18px;height:18px;transition:transform .3s;color:var(--text-3)}
    .ac.ex .chev{transform:rotate(180deg)}

    /* Details */
    .ad{max-height:0;overflow:hidden;transition:max-height .3s ease-out}
    .ac.ex .ad{max-height:1200px;transition:max-height .4s ease-in}
    .adi{padding:0 .7rem .7rem;border-top:1px solid var(--border)}
    .dr{display:flex;align-items:flex-start;gap:.4rem;margin-top:.45rem;font-size:.78rem;color:var(--text-2)}
    .dl{font-weight:600;color:var(--text);min-width:40px;flex-shrink:0;font-size:.75rem}
    .dv{flex:1;white-space:pre-line}
    .ac[data-t="åƒè€ƒ"] .dv{max-height:400px;overflow-y:auto;padding-right:.5rem}
    .ac[data-t="åƒè€ƒ"] .dv::-webkit-scrollbar{width:6px}
    .ac[data-t="åƒè€ƒ"] .dv::-webkit-scrollbar-track{background:transparent}
    .ac[data-t="åƒè€ƒ"] .dv::-webkit-scrollbar-thumb{background:#d1d1d6;border-radius:3px}
    .ac[data-t="åƒè€ƒ"] .dv::-webkit-scrollbar-thumb:hover{background:#a8a8a8}
    .ftags{display:flex;gap:.3rem;flex-wrap:wrap;margin-top:.3rem}
    .ftag{display:inline-flex;align-items:center;gap:.15rem;padding:.1rem .35rem;background:#f0f1f0;border-radius:3px;font-size:.68rem}
    .nwarn{background:#fef9ef;border-left:2px solid var(--accent);padding:.3rem .5rem;margin-top:.4rem;border-radius:0 4px 4px 0;font-size:.75rem;color:#7a6540}
    .ntodo{background:#fff4e5;border-left:2px solid #f59e0b;padding:.3rem .5rem;margin-top:.4rem;border-radius:0 4px 4px 0;font-size:.75rem;color:#92600a}
    .mlink{display:inline-flex;align-items:center;gap:.25rem;padding:.2rem .5rem;background:var(--primary-light);color:var(--primary);border-radius:4px;font-size:.72rem;margin-top:.4rem;transition:background .2s;margin-right:.3rem}
    .mlink.doc{background:#e8f5e9;color:#2e7d32}
    .ah-ticket{background:#fff3e0;color:#e65100;padding:6px 10px;border-radius:8px;font-size:.78rem;font-weight:600;margin-top:6px;display:inline-block}
    .mlink:hover{background:#d4ebe5}

    /* ===== Food Tab ===== */
    .food-info-section{display:grid;grid-template-columns:1fr;gap:.75rem;margin-bottom:1.5rem}
    @media(min-width:600px){.food-info-section{grid-template-columns:1fr 1fr}}
    .food-info-card{background:var(--surface);border-radius:var(--r);padding:.85rem;box-shadow:var(--shadow);border-left:3px solid var(--primary)}
    .food-info-card h3{font-size:.95rem;font-weight:700;color:var(--primary-dark);margin-bottom:.5rem;display:flex;align-items:center;gap:.3rem}
    .food-info-card p{font-size:.8rem;color:var(--text-2);line-height:1.5;margin-bottom:.6rem}
    .food-info-card ul{margin:.5rem 0 .6rem 1.2rem;padding:0}
    .food-info-card li{font-size:.78rem;color:var(--text-2);line-height:1.6;margin:.3rem 0}
    .food-info-card strong{color:var(--text);font-weight:600}
    .food-info-link{display:inline-flex;align-items:center;gap:.3rem;padding:.4rem .75rem;background:var(--primary);color:#fff;border-radius:6px;font-size:.78rem;font-weight:600;text-decoration:none;transition:background .2s}
    .food-info-link:hover{background:var(--primary-dark)}

    .fc-city{margin-bottom:.6rem;border-radius:var(--r);overflow:hidden;background:var(--surface);box-shadow:var(--shadow)}
    .fc-city-h{display:flex;align-items:center;justify-content:space-between;padding:.65rem .85rem;cursor:pointer;user-select:none;background:var(--primary-light);border-bottom:2px solid var(--primary);transition:background .2s}
    .fc-city-h:active{background:#d4ebe5}
    .fc-city-name{font-size:.92rem;font-weight:700;color:var(--primary-dark)}
    .fc-city-meta{display:flex;align-items:center;gap:.4rem}
    .fc-day{font-size:.65rem;background:var(--surface);color:var(--primary);padding:.15rem .45rem;border-radius:10px;white-space:nowrap;font-weight:600}
    .fc-cnt{font-size:.62rem;background:var(--accent);color:#fff;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700}
    .fc-chev{color:var(--primary);transition:transform .3s;flex-shrink:0}
    .fc-city:not(.open) .fc-chev{transform:rotate(-90deg)}
    .fc-items{padding:0 .85rem;max-height:2000px;overflow:hidden;transition:max-height .35s ease,padding .35s ease}
    .fc-city:not(.open) .fc-items{max-height:0;padding:0 .85rem}
    .fc-city:not(.open) .fc-city-h{border-bottom-color:transparent}
    .fc-card{padding:.55rem 0;border-bottom:1px solid var(--border)}
    .fc-card:last-child{border-bottom:none}
    .fc-name{font-size:.88rem;font-weight:600;color:var(--text)}
    .fc-note{font-size:.78rem;color:var(--accent);font-weight:500;margin-top:.15rem}

    /* ===== Accommodation ===== */
    .acard{background:var(--surface);border-radius:var(--r-sm);box-shadow:var(--shadow);margin-top:.6rem;margin-bottom:.85rem;overflow:hidden}
    .acard-h{display:flex;align-items:center;gap:.5rem;padding:.6rem .7rem;cursor:pointer;-webkit-tap-highlight-color:transparent}
    .acard-h .ai{font-size:1.2rem;flex-shrink:0}
    .acard-h h3{flex:1;font-size:.88rem;font-weight:500;line-height:1.3}
    .acard .chev{flex-shrink:0;width:18px;height:18px;transition:transform .3s;color:var(--text-3)}
    .acard.ex .chev{transform:rotate(180deg)}
    .acard-d{max-height:0;overflow:hidden;transition:max-height .3s ease-out}
    .acard.ex .acard-d{max-height:400px;transition:max-height .4s ease-in}
    .acard-di{padding:0 .7rem .7rem;border-top:1px solid var(--border)}
    .aprice{color:var(--accent);font-weight:600;font-size:.82rem}
    .acard-di p{font-size:.78rem;color:var(--text-2);margin-top:.3rem}

    /* ===== Cancelled ===== */
    .cxs{margin-top:.6rem}
    .cxt{display:flex;align-items:center;gap:.4rem;padding:.4rem 0;cursor:pointer;font-size:.78rem;color:var(--text-3);user-select:none}
    .cxt svg{transition:transform .3s}
    .cxs.open .cxt svg{transform:rotate(180deg)}
    .cxi{display:none}
    .cxs.open .cxi{display:block}
    .cxc{background:#f5f5f5;border-radius:var(--r-sm);padding:.45rem .65rem;margin-bottom:.4rem;opacity:.55}
    .cxc .an{text-decoration:line-through;color:var(--text-3);font-size:.82rem}
    .cxc .cn{font-size:.7rem;color:var(--text-3);margin-top:.15rem}

    /* ===== Flights ===== */
    .fc{background:var(--surface);border-radius:var(--r);box-shadow:var(--shadow);margin-bottom:1rem;overflow:hidden}
    .fch{background:var(--primary-light);padding:.65rem .85rem;font-weight:600;color:var(--primary-dark);font-size:.9rem}
    .fdir{padding:.4rem .85rem;font-size:.75rem;color:var(--text-2);border-bottom:1px solid var(--border);font-weight:500;background:#fafafa}
    .fl{display:flex;align-items:center;padding:.55rem .85rem;border-bottom:1px solid var(--border);gap:.6rem}
    .fl:last-child{border-bottom:none}
    .fe{font-size:1.1rem;flex-shrink:0}
    .fi{flex:1}
    .fr{font-size:.82rem;font-weight:500}
    .fd{font-size:.72rem;color:var(--text-2)}
    .ftr{font-size:.72rem;color:var(--accent);padding:.35rem .85rem;background:var(--accent-light)}
    .fcost{padding:.65rem .85rem;background:var(--accent-light);font-size:.82rem;color:#8a6840;font-weight:500}

    /* ===== Packing List ===== */
    .clprog{background:var(--border);border-radius:10px;height:6px;margin-bottom:1rem;overflow:hidden}
    .clbar{background:var(--primary);height:100%;border-radius:10px;transition:width .3s}
    .plcat{margin-bottom:.7rem;background:var(--surface);border-radius:var(--r-sm);box-shadow:var(--shadow);overflow:hidden}
    .plch{display:flex;align-items:center;gap:.4rem;padding:.55rem .7rem;cursor:pointer;user-select:none;border-bottom:1px solid var(--border)}
    .plcat.closed .plch{border-bottom:none}
    .plci{font-size:1rem;flex-shrink:0}
    .plcn{flex:1;font-size:.85rem;font-weight:600}
    .plcc{font-size:.68rem;color:var(--text-3);padding:.1rem .4rem;background:var(--bg);border-radius:10px}
    .plcat .chev{flex-shrink:0;width:16px;height:16px;transition:transform .3s;color:var(--text-3)}
    .plcat.closed .chev{transform:rotate(-90deg)}
    .plcat.closed .plcl{display:none}
    .pltag{font-size:.58rem;padding:.08rem .3rem;border-radius:3px;background:#e8d5f5;color:#7b4ea0;font-weight:500;flex-shrink:0}
    .cli{display:flex;align-items:center;gap:.65rem;padding:.5rem .7rem;cursor:pointer;transition:opacity .2s;user-select:none;border-bottom:1px solid var(--border)}
    .cli:last-child{border-bottom:none}
    .cli.ck{opacity:.45}
    .cli.ck .cltx{text-decoration:line-through}
    .clcb{width:18px;height:18px;border:2px solid var(--border);border-radius:4px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;font-size:.65rem;color:transparent}
    .cli.ck .clcb{background:var(--primary);border-color:var(--primary);color:#fff}
    .cltx{font-size:.82rem;flex:1}

    /* ===== Notes ===== */
    .nt-day{background:var(--surface);border-radius:var(--r-sm);box-shadow:var(--shadow);padding:.6rem .7rem;margin-bottom:.85rem}
    .nt-lbl{font-size:.78rem;font-weight:500;color:var(--text-2);margin-bottom:.3rem;display:flex;align-items:center;gap:.3rem}
    .nt-input{width:100%;border:1px solid var(--border);border-radius:6px;padding:.4rem .55rem;font-size:1rem;font-family:var(--font);resize:vertical;min-height:2.4rem;background:var(--surface);color:var(--text);line-height:1.5}
    .nt-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(42,124,111,.15)}
    .nt-input::placeholder{color:var(--text-3)}
    .nt-card{margin-top:.45rem;padding-top:.35rem;border-top:1px dashed var(--border)}
    .adi>.nt-card:first-child{border-top:none;margin-top:0;padding-top:.1rem}
    .nt-card .nt-input{min-height:2rem;font-size:1rem}
    .nt-dot{width:6px;height:6px;border-radius:50%;background:var(--accent);flex-shrink:0;margin-left:-.2rem}

    /* ===== Tips ===== */
    .tc{background:var(--surface);border-radius:var(--r-sm);box-shadow:var(--shadow);padding:.85rem;margin-bottom:.65rem}
    .tc h3{font-size:.9rem;font-weight:600;margin-bottom:.4rem;display:flex;align-items:center;gap:.4rem}
    .tc ul{padding-left:1.1rem;font-size:.82rem;color:var(--text-2)}
    .tc li{margin-bottom:.3rem}
    .tc .tv{font-size:.82rem;color:var(--text-2)}
    .twarn{background:#fef0f0;border-left:3px solid #e74c3c;padding:.45rem .65rem;border-radius:0 6px 6px 0;margin-top:.4rem;font-size:.78rem;color:#7a2020}

    /* ===== Customs & Fuel Info ===== */
    #customs-info,#fuel-info{margin-bottom:1.2rem}
    .customs-section{margin-top:.5rem}
    .customs-warning,.customs-declare,.customs-note{padding:.5rem .65rem;margin-bottom:.6rem;border-radius:6px;font-size:.78rem}
    .customs-warning{background:#fff5f5;border-left:3px solid #e74c3c}
    .customs-warning strong{color:#c0392b;display:block;margin-bottom:.3rem}
    .customs-declare{background:#fff8e6;border-left:3px solid #f39c12}
    .customs-declare strong{color:#d68910;display:block;margin-bottom:.3rem}
    .customs-note{background:#e8f4f8;border-left:3px solid #3498db}
    .customs-note strong{color:#2980b9}
    .customs-section ul{margin:.3rem 0 0 1.2rem;padding:0}
    .customs-section li{margin:.2rem 0;line-height:1.4}

    /* ===== Section Title ===== */
    .stitle{font-size:1.15rem;font-weight:700;margin-bottom:.85rem;display:flex;align-items:center;gap:.4rem}

    /* ===== Footer ===== */
    .footer{text-align:center;padding:1.5rem;font-size:.72rem;color:var(--text-3)}

    /* ===== Responsive ===== */
    @media(min-width:768px){
      .ct{padding:1.5rem}
      .header{padding:3rem 2rem 2.2rem}
      .header h1{font-size:1.6rem}
    }

    /* ===== Animation ===== */
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .ct{animation:fadeIn .3s ease-out}
  </style>
</head>
<body>
  <div id="app">
    <div style="padding:3rem;text-align:center;color:var(--text-2)">è¼‰å…¥ä¸­...</div>
  </div>

  <script type="module">
  // ç­‰å¾… data.js è¼‰å…¥å®Œæˆ
  await import('./data.js');

  (function(){
    // ===== State =====
    const S = {
      tab: 'itin',
      day: getAutoDay(),
      exp: new Set(),
      cl: loadCL(),
      cc: new Set(),
      nt: loadNT()
    };

    function getAutoDay(){
      const d = Math.floor((new Date()-new Date('2026-02-13'))/864e5);
      return d>=0&&d<=18?d:0;
    }
    function loadCL(){try{return JSON.parse(localStorage.getItem('nz26pk')||'{}')}catch(e){return{}}}
    function saveCL(){localStorage.setItem('nz26pk',JSON.stringify(S.cl))}
    function loadNT(){try{return JSON.parse(localStorage.getItem('nz26nt')||'{}')}catch(e){return{}}}
    function saveNT(){localStorage.setItem('nz26nt',JSON.stringify(S.nt))}

    const FICON = {'åœè»Šå ´':'ğŸ…¿ï¸','å»æ‰€':'ğŸš»','è·¯é‚Šåœè»Š':'ğŸš—','ä»˜è²»å»æ‰€':'ğŸ’°'};
    const TICON = {'æ™¯é»':'ğŸ“','åƒå–':'ğŸ½ï¸','ä½å®¿':'ğŸ ','ä½œæ¥­':'ğŸ“‹','åƒè€ƒ':'ğŸ’¡'};
    const GMAP_URL = 'https://www.google.com/maps/d/u/0/viewer?mid=1I-Tn1fN0KJmqLi_xYKibtde2L8Gn2lo';

    // åˆ¤æ–·ç§»å‹•é¡å‹ï¼ˆé£›æ©Ÿæˆ–é–‹è»Šï¼‰
    function getMoveIcon(activity, day) {
      if (activity.type !== 'ç§»å‹•') return null;
      // å‰å…©å¤©ï¼ˆDay 0-1ï¼‰å’Œå¾Œå…©å¤©ï¼ˆDay 17-18ï¼‰å¼·åˆ¶é¡¯ç¤ºé£›æ©Ÿ
      if (day !== undefined && (day <= 1 || day >= 17)) return 'âœˆï¸';
      return 'ğŸš—';
    }

    // ===== Render =====
    function render(){
      const app = document.getElementById('app');
      app.innerHTML = renderHeader() + renderTabs() + '<div id="ct">' + renderContent() + '</div>';
      if(S.tab==='itin') raf(scrollDay);
    }

    function renderHeader(){
      return `<div class="header">
        <h1>ğŸ‡³ğŸ‡¿ ç´è¥¿è˜­å—å³¶ 2026</h1>
        <div class="sub">${DATA.duration}</div>
        <div class="badges">
          <span class="hbadge">ğŸ§­ ${DATA.tripType}è·¯ç·š</span>
          <span class="hbadge">ğŸš éœ²ç‡Ÿè»Šè‡ªé§•</span>
          <span class="hbadge">ğŸ‘¥ 4äºº</span>
        </div>
      </div>`;
    }

    function renderTabs(){
      const tabs = [
        {k:'itin',i:'ğŸ—“',l:'è¡Œç¨‹'},
        {k:'food',i:'ğŸ½',l:'ç¾é£Ÿ'},
        {k:'flights',i:'âœˆï¸',l:'èˆªç­'},
        {k:'check',i:'ğŸ§³',l:'è¡Œæ'},
        {k:'tips',i:'ğŸ“‹',l:'é ˆçŸ¥'}
      ];
      return `<div class="tabs">${tabs.map(t=>
        `<div class="tab${S.tab===t.k?' on':''}" data-a="tab" data-v="${t.k}">
          <span class="ti">${t.i}</span>${t.l}
        </div>`
      ).join('')}</div>`;
    }

    function renderContent(){
      switch(S.tab){
        case 'itin': return renderItin();
        case 'food': return renderFood();
        case 'flights': return renderFlights();
        case 'check': return renderCheck();
        case 'tips': return renderTips();
      }
    }

    // ===== Itinerary =====
    function renderItin(){
      return renderDaySel() + '<div class="ct" id="dv">' + renderDayView() + '</div>';
    }

    function renderDaySel(){
      return `<div class="day-sel" id="ds">${DATA.days.map(d=>{
        const icon = (d.day<=1||d.day===18) ? 'âœˆï¸ ' : '';
        return `<div class="dp${S.day===d.day?' on':''}" data-a="day" data-v="${d.day}">
          <div class="dd">${icon}${d.date}</div>
          <div class="dw">D${d.day} (${d.weekday})</div>
        </div>`;
      }).join('')}</div>`;
    }

    function renderDayView(){
      const d = DATA.days[S.day];
      if(!d) return '';
      const active = [];
      d.activities.forEach((a,i)=>{if(!a.cancelled) active.push({a:a,idx:i})});
      const cxd = d.activities.filter(a=>a.cancelled);
      const hasStats = d.km>0||(d.driveTime&&d.driveTime!=='0');

      return `<div class="dh">
        <h2>${d.title}</h2>
        <div class="ddate">${d.date} (${d.weekday}) Â· ç¬¬ ${d.day} å¤©</div>
      </div>
      ${hasStats?`<div class="stats">
        ${d.km>0?`<span class="st">ğŸš— ${d.km} km</span>`:''}
        ${d.driveTime&&d.driveTime!=='0'?`<span class="st">â± ${d.driveTime}</span>`:''}
        ${d.route?`<span class="st">ğŸ“ ${d.route}</span>`:''}
      </div>`:''}
      ${d.driveNotes?`<div class="dnote">ğŸ“Œ ${esc(d.driveNotes).replace(/\n/g,'<br>')}</div>`:''}
      ${(function() {
        const weather = getWeatherForDay(d.title, d.accommodation ? d.accommodation.name : '');
        if (weather) {
          return `<div class="weather-info">
            <div><span class="wi-label">å¤©æ°£æ¦‚æ³:</span> <a href="${esc(weather.url)}" target="_blank" rel="noopener">${esc(weather.location)}</a></div>
            <div><span class="wi-label">æº«åº¦:</span> ${esc(weather.temp)}</div>
            <div><span class="wi-label">ç‹€æ³:</span> ${esc(weather.condition)}</div>
            <div><span class="wi-label">å»ºè­°:</span> ${esc(weather.tips)}</div>
          </div>`;
        }
        return '';
      })()}
      <div class="map-sec" id="mapsec">
        <div class="map-tog" data-a="maptog">
          ğŸ—ºï¸ é¡¯ç¤ºè·¯ç·šåœ°åœ–
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg>
          <a class="map-open-btn" href="${GMAP_URL}" target="_blank" rel="noopener" onclick="event.stopPropagation()">é–‹å•Ÿå®Œæ•´åœ°åœ– â†—</a>
        </div>
        <div class="map-fr">
          <iframe src="https://www.google.com/maps/d/embed?mid=1I-Tn1fN0KJmqLi_xYKibtde2L8Gn2lo" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
        </div>
      </div>
      <div class="tl">
        ${active.map(item=>renderAC(item.a,S.day+'-'+item.idx,S.day)).join('')}
      </div>
      ${cxd.length?renderCX(cxd):''}
      ${d.accommodation?renderAccom(d.accommodation,S.day):''}
      <div class="nt-day">
        <div class="nt-lbl">ğŸ“ ä»Šæ—¥å‚™è¨»</div>
        <textarea class="nt-input" data-nk="d${d.day}" placeholder="è¨˜éŒ„ä»Šå¤©çš„æƒ³æ³•...">${esc(S.nt['d'+d.day]||'')}</textarea>
      </div>`;
    }

    function renderAC(a,key,day){
      const isEx = S.exp.has(key);
      const sch = DATA.schedules&&DATA.schedules[key];
      const schTime = sch&&sch.s;
      const drv = sch&&sch.d;
      const isRange = schTime&&/^\d{2}:\d{2}-\d{2}:\d{2}/.test(schTime);
      const hasSub = schTime||a.time||drv;
      const noteVal = S.nt[key]||'';
      return `<div class="ac${isEx?' ex':''}" data-t="${a.type}" data-k="${key}">
        ${drv?`<div class="ah-drive">${drv.includes('æ­¥è¡Œ')?'ğŸš¶':drv.includes('è¨ˆç¨‹è»Š')?'ğŸš•':'ğŸš—'} ${esc(drv)}</div>`:''}
        <div class="ah" data-a="tog" data-v="${key}">
          <div class="ah-top">
            ${a.type.split('+').map(t=>{
              const icon = t === 'ç§»å‹•' ? getMoveIcon(a, day) : (TICON[t] || 'ğŸ“Œ');
              return `<span class="ab ab-${t}">${icon} ${t}</span>`;
            }).join('')}
            <span class="an">${esc(getDisplayName(a))}</span>
            ${noteVal?'<span class="nt-dot"></span>':''}
            <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg>
          </div>
          ${hasSub?`<div class="ah-sub">
            ${schTime?`<span>ğŸ“ ${esc(schTime)}${isRange&&a.time?' ('+esc(a.time)+')':''}</span>`:(a.time?`<span>â± ${esc(a.time)}</span>`:'')}
            ${!schTime&&a.hours?`<span>ğŸ• ${esc(a.hours)}</span>`:''}
          </div>`:''}
        </div>
        <div class="ad"><div class="adi">
          ${a.description?`<div class="dr"><span class="dl">èªªæ˜</span><span class="dv">${esc(a.description)}</span></div>`:''}
          ${a.hours?`<div class="dr"><span class="dl">${a.type==='ç§»å‹•'?'èˆªç­':'ç‡Ÿæ¥­'}</span><span class="dv">${esc(a.hours)}</span></div>`:''}
          ${a.facilities&&a.facilities.length?`<div class="dr"><span class="dl">è¨­æ–½</span><div class="ftags">${a.facilities.map(f=>`<span class="ftag">${FICON[f]||'ğŸ“'} ${esc(f)}</span>`).join('')}</div></div>`:''}
          ${a.ticket?`<div class="ah-ticket">ğŸ« ${esc(a.ticket)}</div>`:''}
          ${a.notes?(a.notes.includes('TODO')?`<div class="ntodo">ğŸ“Œ ${esc(a.notes)}</div>`:`<div class="nwarn">${esc(a.notes)}</div>`):''}
          ${a.docLink?`<a class="mlink doc" href="${a.docLink}" target="_blank" rel="noopener">ğŸ“‹ DOC æ­¥é“è³‡è¨Š</a>`:''}
          ${a.type!=='ç§»å‹•'?`<a class="mlink" href="${getMapUrl(a)}" target="_blank" rel="noopener">ğŸ“ Google Maps</a>`:''}
          <div class="nt-card">
            <textarea class="nt-input" data-nk="${key}" placeholder="ğŸ“ å¯«ä¸‹å‚™è¨»...">${esc(noteVal)}</textarea>
          </div>
        </div></div>
      </div>`;
    }

    function renderCX(items){
      return `<div class="cxs" id="cxs">
        <div class="cxt" data-a="cxtog">
          âŠ˜ å·²æ’é™¤æ™¯é» (${items.length})
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg>
        </div>
        <div class="cxi">${items.map((a,idx)=>{
          const key = 'cx-'+idx;
          const isEx = S.exp.has(key);
          const noteVal = S.nt[key]||'';
          return `<div class="ac cancelled${isEx?' ex':''}" data-t="${a.type}" data-k="${key}">
            <div class="ah" data-a="tog" data-v="${key}">
              <div class="ah-top">
                ${a.type.split('+').map(t=>{
                  const icon = TICON[t] || 'ğŸ“Œ';
                  return `<span class="ab ab-${t}">${icon} ${t}</span>`;
                }).join('')}
                <span class="an">${esc(getDisplayName(a))}</span>
                ${noteVal?'<span class="nt-dot"></span>':''}
                <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg>
              </div>
              ${a.time?`<div class="ah-sub">
                <span>â± ${esc(a.time)}</span>
                ${a.hours?`<span>ğŸ• ${esc(a.hours)}</span>`:''}
              </div>`:''}
            </div>
            <div class="ad"><div class="adi">
              ${a.description?`<div class="dr"><span class="dl">èªªæ˜</span><span class="dv">${esc(a.description)}</span></div>`:''}
              ${a.hours?`<div class="dr"><span class="dl">${a.type==='ç§»å‹•'?'èˆªç­':'ç‡Ÿæ¥­'}</span><span class="dv">${esc(a.hours)}</span></div>`:''}
              ${a.facilities&&a.facilities.length?`<div class="dr"><span class="dl">è¨­æ–½</span><div class="ftags">${a.facilities.map(f=>`<span class="ftag">${FICON[f]||'ğŸ“'} ${esc(f)}</span>`).join('')}</div></div>`:''}
              ${a.ticket?`<div class="ah-ticket">ğŸ« ${esc(a.ticket)}</div>`:''}
              ${a.notes?`<div class="nwarn">ğŸ“Œ ${esc(a.notes)}</div>`:''}
              ${a.docLink?`<a class="mlink doc" href="${a.docLink}" target="_blank" rel="noopener">ğŸ“‹ DOC æ­¥é“è³‡è¨Š</a>`:''}
              ${a.type!=='ç§»å‹•'?`<a class="mlink" href="${getMapUrl(a)}" target="_blank" rel="noopener">ğŸ“ Google Maps</a>`:''}
              <div class="nt-card">
                <textarea class="nt-input" data-nk="${key}" placeholder="ğŸ“ å¯«ä¸‹å‚™è¨»...">${esc(noteVal)}</textarea>
              </div>
            </div></div>
          </div>`;
        }).join('')}</div>
      </div>`;
    }

    function renderAccom(acc,day){
      if(!acc.name) return '';
      const akey = 'acc-'+day;
      const isEx = S.exp.has(akey);
      const noteVal = S.nt[akey]||'';
      const isPlace = acc.name!=='é£›æ©Ÿä¸Š';
      const searchName = extractEnglish(acc.name);
      const mapUrl = acc.mapLink || (isPlace && searchName?'https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(searchName+' New Zealand'):'');
      const icon = isPlace?'ğŸ ':'âœˆï¸';
      return `<div class="acard${isEx?' ex':''}">
        <div class="acard-h" data-a="tog" data-v="${akey}">
          <span class="ai">${icon}</span>
          <h3>${esc(acc.name)}</h3>
          ${noteVal?'<span class="nt-dot"></span>':''}
          <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg>
        </div>
        <div class="acard-d"><div class="acard-di">
          ${acc.price?`<p class="aprice">ğŸ’° ${esc(acc.price)}</p>`:''}
          ${acc.checkIn?`<p>ğŸ”‘ Check-in: ${esc(acc.checkIn)}</p>`:''}
          ${acc.checkOut?`<p>ğŸšª Check-out: ${esc(acc.checkOut)}</p>`:''}
          ${acc.notes?`<p>${esc(acc.notes)}</p>`:''}
          ${mapUrl?`<a class="mlink" href="${mapUrl}" target="_blank" rel="noopener">ğŸ“ Google Maps</a>`:''}
          <div class="nt-card">
            <textarea class="nt-input" data-nk="${akey}" placeholder="ğŸ“ ä½å®¿å‚™è¨»...">${esc(noteVal)}</textarea>
          </div>
        </div></div>
      </div>`;
    }

    // ===== Food =====
    function renderFood(){
      return `<div class="ct">
        <div class="stitle">ğŸ½ ç¾é£Ÿæ¨è–¦</div>

        <div class="food-info-section">
          <div class="food-info-card">
            <h3>ğŸ›’ ç´è¥¿è˜­è¶…å¸‚æ¡è³¼æŒ‡å—</h3>
            <p>åœ¨ç´è¥¿è˜­æ—…è¡Œï¼Œè¶…å¸‚æ¡è³¼æ˜¯çœéŒ¢çš„å¥½æ–¹æ³•ï¼äº†è§£å„å¤§è¶…å¸‚çš„ç‰¹è‰²ã€å¿…è²·å•†å“å’Œåƒ¹æ ¼æ¯”è¼ƒã€‚</p>
            <a href="https://timtingtravel.com/new-zealand-supermarket/" target="_blank" rel="noopener" class="food-info-link">
              ğŸ“– é–±è®€å®Œæ•´è¶…å¸‚æ”»ç•¥ â†’
            </a>
          </div>
          <div class="food-info-card">
            <h3>ğŸ´ ç¾é£Ÿç‰¹è‰²</h3>
            <ul>
              <li><strong>é¹¹æ´¾ (Pie)ï¼š</strong>ç´è¥¿è˜­åœ‹æ°‘ç¾é£Ÿï¼Œæ¨è–¦ Fairlie Bakehouseã€Arrowtown Bakery</li>
              <li><strong>æ¼¢å ¡ï¼š</strong>Fergburger æ˜¯å¿…åƒç¶“å…¸ï¼Œè±¬è‚‰å£å‘³å„ªæ–¼ç‰›è‚‰</li>
              <li><strong>å†°æ·‡æ·‹ï¼š</strong>Patagonia Chocolates æ˜¯ç´è¥¿è˜­æœ€æœ‰åçš„å†°æ·‡æ·‹åº—</li>
              <li><strong>é®­é­šï¼š</strong>Mt Cook Alpine Salmon Shopã€High Country Salmon æä¾›æ–°é®®é®­é­š</li>
            </ul>
          </div>
        </div>

        <div class="stitle" style="font-size:1rem;margin-top:1.5rem;margin-bottom:.75rem">ğŸ“ ä¾åŸå¸‚åˆ†é¡</div>
        <p style="font-size:.82rem;color:var(--text-2);margin-bottom:1rem">é»æ“Šå±•é–‹ / æ”¶åˆ</p>
        ${DATA.food.map((g,gi)=>`
          <div class="fc-city open" data-fc="${gi}">
            <div class="fc-city-h" data-a="fc-tog" data-v="${gi}">
              <span class="fc-city-name">${esc(g.city)}</span>
              <span class="fc-city-meta"><span class="fc-day">${esc(g.days)}</span><span class="fc-cnt">${g.items.length}</span><svg class="fc-chev" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 12 15 18 9"/></svg></span>
            </div>
            <div class="fc-items">
              ${g.items.map(r=>`
                <div class="fc-card">
                  <div class="fc-name">${esc(r.name)}</div>
                  ${r.note?`<div class="fc-note">${esc(r.note)}</div>`:''}
                  <a href="${r.mapLink||('https://www.google.com/maps/search/'+encodeURIComponent(extractEnglish(r.name)+' New Zealand'))}" target="_blank" rel="noopener" class="mlink" style="margin-top:.3rem;font-size:.72rem">ğŸ“ Google Maps</a>
                </div>
              `).join('')}
            </div>
          </div>
        `).join('')}
      </div>`;
    }

    // ===== Flights =====
    function renderFlights(){
      return `<div class="ct">
        <div class="stitle">âœˆï¸ èˆªç­è³‡è¨Š</div>
        ${renderFRoute('é«˜é›„ KHH å‡ºç™¼',DATA.flights.kaohsiung)}
        ${renderFRoute('æ¡ƒåœ’ TPE å‡ºç™¼',DATA.flights.taipei)}
      </div>`;
    }

    function renderFRoute(label,route){
      return `<div class="fc">
        <div class="fch">${label}</div>
        <div class="fdir">å»ç¨‹</div>
        ${route.outbound.map(renderFLeg).join('')}
        <div class="fdir">å›ç¨‹</div>
        ${route.inbound.map(renderFLeg).join('')}
        ${route.totalCost?`<div class="fcost">ğŸ’° ${route.totalCost}</div>`:''}
      </div>`;
    }

    function renderFLeg(leg){
      const fromText = esc(leg.from) + (leg.fromTerminal ? ` (${leg.fromTerminal})` : '');
      const toText = esc(leg.to) + (leg.toTerminal ? ` (${leg.toTerminal})` : '');
      return `${leg.transit?`<div class="ftr">â³ è½‰æ©Ÿç­‰å€™ ${leg.transit}</div>`:''}
      <div class="fl">
        <div class="fe">âœˆï¸</div>
        <div class="fi">
          <div class="fr">${fromText} â†’ ${toText}</div>
          <div class="fd">${leg.flight} Â· ${leg.depart} â†’ ${leg.arrive} Â· ${leg.duration}</div>
        </div>
      </div>`;
    }

    // ===== Packing List =====
    function renderCheck(){
      const pl = DATA.packingList;
      let total=0, done=0;
      pl.forEach((cat,ci)=>cat.items.forEach((_,ii)=>{total++;if(S.cl[ci+'-'+ii])done++}));
      const pct = total?Math.round(done/total*100):0;

      // æ”¶é›†æ‰€æœ‰è² è²¬äºº
      const whoSet = new Set();
      pl.forEach(cat=>cat.items.forEach(item=>{if(item.who)whoSet.add(item.who)}));
      const whoOrder = ['çˆ¸','åª½','Ann','ç¿”'];
      const whos = whoOrder.filter(w=>whoSet.has(w));
      const whoColors = {'çˆ¸':'#5b9bd5','åª½':'#ff69b4','Ann':'#f4c430','ç¿”':'#4caf50'};

      return `<div class="ct">
        <div class="stitle">ğŸ§³ è¡Œææ¸…å–®</div>
        <p style="font-size:.82rem;color:var(--text-2);margin-bottom:.75rem">${done}/${total} å·²æ‰“åŒ… (${pct}%)</p>
        <div class="clprog"><div class="clbar" style="width:${pct}%"></div></div>

        <div style="background:var(--accent-light);border-left:3px solid var(--accent);padding:.75rem 1rem;border-radius:var(--r-sm);margin:.75rem 0;font-size:.8rem;line-height:1.6">
          <div style="font-weight:600;color:var(--accent);margin-bottom:.5rem">âœˆï¸ æ‰˜é‹è¡Œææ³¨æ„äº‹é …</div>
          <div style="color:var(--text-2)">
            <div style="margin-bottom:.3rem">ğŸ“¦ <strong>é‡é‡é™åˆ¶</strong>ï¼šç¶“æ¿Ÿè‰™å–®ä»¶æœ€å¤š 23kgï¼Œå•†å‹™è‰™ 32kg</div>
            <div style="margin-bottom:.3rem">ğŸ’§ <strong>æ¶²é«”è¦å®š</strong>ï¼šæ‰‹æè¡Œæå–®ç“¶â‰¤100mlï¼Œç¸½é‡â‰¤1Lï¼ˆéœ€è£é€æ˜è¢‹ï¼‰</div>
            <div style="margin-bottom:.3rem">ğŸ”‹ <strong>é›»æ± /è¡Œå‹•é›»æº</strong>ï¼šå¿…é ˆæ‰‹æï¼Œâ‰¤100Wh æœ€å¤š 20 ä»¶ï¼Œï¼100Wh éœ€ç”³å ±</div>
            <div style="margin-bottom:.3rem">ğŸš« <strong>æ‰“ç«æ©Ÿ</strong>ï¼šç‡ƒæ–™å¼æ‰“ç«æ©Ÿç¦æ­¢æ‰˜é‹å’Œæ‰‹æ</div>
            <div style="margin-bottom:.3rem">ğŸš¬ <strong>é¦™ç…™</strong>ï¼šå¯æ”œå¸¶ä½†éœ€ç¬¦åˆç›®çš„åœ°æµ·é—œè¦å®š</div>
            <div style="font-size:.72rem;color:var(--text-3);margin-top:.5rem">
              è©³è¦‹ï¼š<a href="https://www.cathaypacific.com/cx/zh_TW/baggage.html" target="_blank" style="color:var(--accent)">åœ‹æ³°èˆªç©ºè¡Œæè¦å®š</a>
            </div>
          </div>
        </div>

        ${whos.length>0?`<div style="display:flex;gap:.5rem;flex-wrap:wrap;margin:.75rem 0">
          ${whos.map(who=>{
            const color=whoColors[who]||'#888';
            return `<span style="display:inline-block;padding:.25rem .6rem;border-radius:12px;font-size:.75rem;background:${color}22;color:${color};border:1px solid ${color}44">${esc(who)}</span>`;
          }).join('')}
        </div>`:''}
        ${pl.map((cat,ci)=>{
          const catDone=cat.items.filter((_,ii)=>S.cl[ci+'-'+ii]).length;
          const closed=S.cc.has(ci);
          return `<div class="plcat${closed?' closed':''}">
            <div class="plch" data-a="cattog" data-v="${ci}">
              <span class="plci">${cat.icon}</span>
              <span class="plcn">${esc(cat.cat)}</span>
              ${cat.who?`<span class="pltag">${esc(cat.who)}</span>`:''}
              <span class="plcc">${catDone}/${cat.items.length}</span>
              <svg class="chev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="6 9 12 15 18 9"/></svg>
            </div>
            <div class="plcl">${cat.items.map((item,ii)=>{
              const key=ci+'-'+ii;const ck=S.cl[key];
              const itemColor=item.who?whoColors[item.who]||'#888':'';
              return `<div class="cli${ck?' ck':''}" data-a="ck" data-v="${key}">
                <div class="clcb">${ck?'âœ“':''}</div>
                <div style="flex:1">
                  <span class="cltx">${esc(item.item)}</span>
                  ${item.who?`<span class="pltag" style="background:${itemColor}22;color:${itemColor};border-color:${itemColor}44">${esc(item.who)}</span>`:''}
                  ${item.notes?`<div style="font-size:.72rem;color:var(--text-3);margin-top:.15rem">${esc(item.notes)}</div>`:''}
                </div>
              </div>`;
            }).join('')}</div>
          </div>`;
        }).join('')}
      </div>`;
    }

    // ===== Tips =====
    function renderTips(){
      const dt = DATA.drivingTips;
      const tp = DATA.tips;
      return `<div class="ct">
        <div class="stitle">ğŸ“‹ è¡Œå‰é ˆçŸ¥</div>

        ${tp.customs?`<div class="tc" id="customs-info">
          <h3>ğŸ›ƒ å…¥é—œé£Ÿå“è¦å®š</h3>
          <div class="customs-section">
            <div class="customs-warning">
              <strong>â›” ç¦æ­¢æ”œå¸¶ï¼ˆé•è€…é‡ç½°ï¼‰</strong>
              <ul>${tp.customs.prohibited.map(item=>`<li>${esc(item)}</li>`).join('')}</ul>
            </div>
            <div class="customs-declare">
              <strong>âš ï¸ å¯æ”œå¸¶ï¼Œä½†éœ€ç”³å ±</strong>
              <ul>${tp.customs.declarable.map(item=>`<li>${esc(item)}</li>`).join('')}</ul>
            </div>
            ${tp.customs.noodles_note?`<div class="customs-note">
              <strong>ğŸ“¦ æ³¡éºµ/æ¯éºµï¼š</strong>${esc(tp.customs.noodles_note)}
            </div>`:''}
          </div>
        </div>`:''}

        ${tp.fuel_stations?`<div class="tc" id="fuel-info">
          <h3>â›½ é—œéµåŠ æ²¹ç«™æé†’</h3>
          <div class="customs-section">
            <div class="customs-warning" style="border-left-color:#e74c3c">
              <strong>â›½â›½â›½ å¿…é ˆåŠ æ²¹ï¼ˆæ²’æœ‰ä¸‹ä¸€ç«™ï¼‰</strong>
              <ul>${tp.fuel_stations.critical_points.map(point=>`
                <li>
                  <strong>${esc(point.day)} - ${esc(point.location)}</strong><br>
                  ${esc(point.reason)}
                  ${point.distance?`<br><span style="font-size:.85em;color:var(--text-3)">${esc(point.distance)}</span>`:''}
                  ${point.note?`<br><span style="font-size:.85em;color:#e74c3c">${esc(point.note)}</span>`:''}
                </li>
              `).join('')}</ul>
            </div>
            <div class="customs-declare" style="border-left-color:#f39c12">
              <strong>â›½ å»ºè­°åŠ æ²¹ï¼ˆç‚ºä¸‹ä¸€æ®µæº–å‚™ï¼‰</strong>
              <ul>${tp.fuel_stations.important_points.map(point=>`
                <li><strong>${esc(point.day)} - ${esc(point.location)}</strong><br>${esc(point.reason)}</li>
              `).join('')}</ul>
            </div>
            ${tp.fuel_stations.general_tips?`<div class="customs-note">
              <strong>ğŸ’¡ åŠ æ²¹å°æé†’ï¼š</strong>
              <ul style="margin:.5rem 0 0 1.2rem;padding:0">
                ${tp.fuel_stations.general_tips.map(tip=>`<li style="font-size:.85em;line-height:1.6;margin:.2rem 0">${esc(tip)}</li>`).join('')}
              </ul>
            </div>`:''}
          </div>
        </div>`:''}

        <div class="tc">
          <h3>ğŸš— é§•é§›é ˆçŸ¥</h3>
          <div class="nwarn" style="margin-bottom:.5rem">âš ï¸ ${esc(dt.note)}</div>
          <ul>
            <li>é§•é§›æ™‚é–“ï¼š${esc(dt.drivingHours)}</li>
            <li>é€Ÿé™ï¼šå…¬è·¯ ${dt.speedLimit.highway} / éœ²ç‡Ÿè»Š ${dt.speedLimit.campervan} / å°é® ${dt.speedLimit.town}</li>
            <li>æ¯æ—¥ç›®æ¨™ï¼š${esc(dt.dailyTarget)}</li>
            <li>å°èˆªæ™‚é–“ï¼šGoogle Maps Ã— ${esc(dt.timeMultiplier)}</li>
            <li>éœ²ç‡Ÿè»Šé•·ï¼š${dt.campervanLength}</li>
          </ul>
        </div>

        <div class="tc">
          <h3>ğŸ›£ï¸ é‡è¦è·¯ç·šæé†’</h3>
          <ul>${dt.importantRoutes.map(r=>`<li>${esc(r)}</li>`).join('')}</ul>
        </div>

        ${dt.gasStationTips?`<div class="tc">
          <h3>â›½ åŠ æ²¹é ˆçŸ¥</h3>
          <ul>
            <li><strong>ç‡ƒæ–™é¡å‹ï¼š</strong>${esc(dt.gasStationTips.fuelType)}</li>
            <li><strong>ä»˜æ¬¾æ–¹å¼ï¼š</strong>${esc(dt.gasStationTips.payment)}</li>
            <li><strong>é—œéµåŠ æ²¹é»ï¼š</strong>${esc(dt.gasStationTips.crucialPoints)}</li>
            <li><strong>å¯¦ç”¨å·¥å…·ï¼š</strong>${esc(dt.gasStationTips.apps)}</li>
            <li><strong>è·¯ç¨… (RUC)ï¼š</strong>${esc(dt.gasStationTips.ruc)}</li>
          </ul>
        </div>`:''}

        <div class="tc">
          <h3>ğŸš éœ²ç‡Ÿè»Šè³‡è¨Š</h3>
          <ul>
            <li>é ç´„ç·¨è™Ÿï¼š${tp.campervan.bookingRef}</li>
            <li>å–è»Š ${tp.campervan.pickupTime} / å‡ºç™¼ ${tp.campervan.departTime}</li>
            <li>è²»ç”¨ï¼š${tp.campervan.totalCost}</li>
            <li>è»Šé•·ï¼š${tp.campervan.length}</li>
          </ul>
        </div>

        <div class="tc">
          <h3>ğŸ›’ è¶…å¸‚æ¡è³¼</h3>
          <div class="tv">${esc(tp.supermarket)}</div>
        </div>

        ${tp.sandfly_warning?`<div class="tc">
          <h3>ğŸ¦Ÿ æ²™èšŠ(æ²™è …)è­¦å‘Š</h3>
          <div class="twarn">${esc(tp.sandfly_warning)}</div>
        </div>`:''}

        <div class="tc">
          <h3>ğŸ’± åŒ¯ç‡åƒè€ƒ</h3>
          <ul>
            <li>1 USD â‰ˆ ${DATA.currency.usd_to_twd} TWD</li>
            <li>1 NZD â‰ˆ ${DATA.currency.nzd_to_twd} TWD</li>
          </ul>
        </div>

        <div class="tc">
          <h3>ğŸ—ºï¸ è¡Œç¨‹åœ°åœ–</h3>
          <div class="tv">
            <a href="${GMAP_URL}" target="_blank" rel="noopener" class="mlink" style="margin-top:0">ğŸ“ åœ¨ Google Maps æŸ¥çœ‹å®Œæ•´è·¯ç·š</a>
          </div>
        </div>
      </div>`;
    }

    // ===== Events =====
    document.getElementById('app').addEventListener('click', function(e){
      const t = e.target.closest('[data-a]');
      if(!t) return;
      const a = t.dataset.a, v = t.dataset.v;

      if(a==='tab'){
        S.tab = v;
        S.exp.clear();
        render();
        // èˆªç­ã€è¡Œæã€é ˆçŸ¥é ç±¤æ»¾å‹•åˆ°é ‚ç«¯ï¼Œè¡Œç¨‹å’Œç¾é£Ÿä¿ç•™ä½ç½®
        if(v==='flights'||v==='check'||v==='tips'){
          raf(()=>window.scrollTo({top:0,behavior:'smooth'}));
        }
      }
      if(a==='day'){
        S.day = Number(v);
        S.exp.clear();
        document.querySelectorAll('.dp').forEach(p=>p.classList.toggle('on',Number(p.dataset.v)===S.day));
        const dv = document.getElementById('dv');
        if(dv) dv.innerHTML = renderDayView();
        raf(()=>{
          // ç›´æ¥æ»¾å‹•åˆ°å›ºå®šä½ç½®ï¼Œç¢ºä¿ header å®Œå…¨éš±è—
          // Header ç´„ 150-180pxï¼Œæ»¾å‹•åˆ° 200px ç¢ºä¿éš±è—
          window.scrollTo({top:200, behavior:'smooth'});
        });
      }
      if(a==='tog'){
        e.preventDefault();
        const key = v;
        const card = t.closest('.ac')||t.closest('.acard');
        if(S.exp.has(key)){S.exp.delete(key);card.classList.remove('ex')}
        else{S.exp.add(key);card.classList.add('ex')}
      }
      if(a==='maptog'){
        const sec = document.getElementById('mapsec');
        if(sec) sec.classList.toggle('open');
      }
      if(a==='cxtog'){
        const sec = t.closest('.cxs');
        if(sec) sec.classList.toggle('open');
      }
      if(a==='cattog'){
        const ci = Number(v);
        if(S.cc.has(ci)) S.cc.delete(ci); else S.cc.add(ci);
        const ct = document.getElementById('ct');
        if(ct) ct.innerHTML = renderContent();
      }
      if(a==='ck'){
        S.cl[v] = !S.cl[v];
        saveCL();
        const ct = document.getElementById('ct');
        if(ct) ct.innerHTML = renderContent();
      }
      if(a==='fc-tog'){
        const sec = t.closest('.fc-city');
        if(sec) sec.classList.toggle('open');
      }
    });

    // ===== Note Input =====
    document.getElementById('app').addEventListener('input', function(e){
      if(e.target.classList.contains('nt-input')){
        const key = e.target.dataset.nk;
        if(key){S.nt[key]=e.target.value;saveNT()}
      }
    });

    // ===== Utils =====
    function getMapUrl(a){
      if(a.mapLink) return a.mapLink;
      const searchName = a.nameEn || a.nameCn || '';
      if (!searchName) return '';
      const q = encodeURIComponent(searchName + ' New Zealand');
      return 'https://www.google.com/maps/search/?api=1&query=' + q;
    }

    function getDisplayName(a){
      if (a.nameCn && a.nameEn) {
        return `${a.nameCn} ${a.nameEn}`;
      }
      return a.nameCn || a.nameEn || '';
    }

    function extractEnglish(str){
      if (!str) return '';
      const enMatch = str.match(/[a-zA-Z][a-zA-Z0-9\s\-'&.()]*/g);
      return enMatch ? enMatch.join(' ').trim() : str;
    }

    function getWeatherForDay(dayTitle, accommodationName) {
      const weatherMap = {
        'åŸºç£åŸ': DATA.weatherInfo.christchurch,
        'è’‚å¡æ³¢': DATA.weatherInfo.tekapo,
        'åº«å…‹å±±': DATA.weatherInfo.mtcook,
        'çš‡åé®': DATA.weatherInfo.queenstown,
        'è’‚é˜¿ç‘™': DATA.weatherInfo.teanau,
        'ç¥å¥‡å³½ç£': DATA.weatherInfo.milford, // Using Milford for Doubtful Sound
        'ç“¦ç´å¡': DATA.weatherInfo.wanaka,
        'è¥¿æµ·å²¸': DATA.weatherInfo.westcoast,
        'ç¦å…‹æ–¯å†°æ²³': DATA.weatherInfo.westcoast, // Fox Glacier is on West Coast
        'éœåŸºè’‚å¡': DATA.weatherInfo.westcoast, // Hokitika is on West Coast
      };

      for (const keyword in weatherMap) {
        if (dayTitle.includes(keyword) || (accommodationName && accommodationName.includes(keyword))) {
          return weatherMap[keyword];
        }
      }
      return null;
    }

    function esc(s){
      if(!s) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
    function raf(fn){requestAnimationFrame(fn)}
    function scrollDay(){
      const el = document.querySelector('.dp.on');
      if(el) el.scrollIntoView({inline:'center',block:'nearest',behavior:'smooth'});
    }

    // ===== Init =====
    if(typeof DATA==='undefined'){
      document.getElementById('app').innerHTML='<p style="padding:3rem;text-align:center;color:var(--text-2)">âš ï¸ æ‰¾ä¸åˆ°è¡Œç¨‹è³‡æ–™ï¼Œè«‹ç¢ºèª data.js æª”æ¡ˆå­˜åœ¨</p>';
    } else {
      render();
    }
  })();
  </script>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('Service Worker è¨»å†ŠæˆåŠŸ:', reg.scope))
          .catch(err => console.log('Service Worker è¨»å†Šå¤±æ•—:', err));
      });
    }
  </script>
</body>
</html>
